# integration:proto:sandbox and integration:compiler-rejections do not
# require access to the binaries like the "true" integration tests
# below. Therefore, they do not extend the .integration_template.

integration:proto:sandbox:
  extends: .test_template
  script:
    - dune build @runtest_sandbox

integration:compiler-rejections:
  extends: .test_template
  script:
    - dune build @runtest_rejections

############################################################
## Stage: run scripts to check they are working properly  ##
############################################################

script:prepare_migration_test:
  extends: .test_template
  before_script:
    - last_proto_name=$(find src -name "proto_[0-9][0-9][0-9]_*" | awk -F'/' '{print $NF}' | sort -r | head -1)
    - last_proto_version=$(echo $last_proto_name | cut -d'_' -f2)
    - new_proto_version=$(printf "%03d" $((10#$last_proto_version + 1)))
    - make
  script:
    # FIXME: https://gitlab.com/tezos/tezos/-/issues/2865
    - sudo chown -R $(id -u):$(id -g) $CI_PROJECT_DIR
    - ./scripts/prepare_migration_test.sh manual "next_$new_proto_version" 1

script:snapshot_alpha_and_link:
  extends: .test_template
  script:
    # FIXME: https://gitlab.com/tezos/tezos/-/issues/2865
    - sudo chown -R $(id -u):$(id -g) $CI_PROJECT_DIR
    - last_proto_name=$(find src -name "proto_[0-9][0-9][0-9]_*" | awk -F'/' '{print $NF}' | sort -r | head -1)
    - last_proto_version=$(echo $last_proto_name | cut -d'_' -f2)
    - new_proto_version=$(printf "%03d" $((10#$last_proto_version + 1)))
    - make tezos-protocol-compiler
    - ./scripts/snapshot_alpha_and_link.sh "$new_proto_version" next
    - make
    - dune build src/proto_"$new_proto_version"_*/

script:test-gen-genesis:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_test_dependencies_template
    - .rules_template__development
  stage: test
  needs: []
  before_script:
    - cd scripts/gen-genesis
  script:
    - dune build gen_genesis.exe

script:test_release_versions:
  extends: .test_template
  script:
    # FIXME: https://gitlab.com/tezos/tezos/-/issues/2865
    - sudo chown -R $(id -u):$(id -g) $CI_PROJECT_DIR
    - ./scripts/test_release_version.sh

############################################################
## Stage: run OCaml integration tests                     ##
############################################################

integration:sandboxes:acc-endorsement:
  extends: .integration_template
  script:
    - TMP=$PWD make -f sandbox.Makefile accusations_simple_double_endorsing
  artifacts:
    paths:
      - flextesa-acc-sde
      - $BISECT_FILE
    expire_in: 1 day
    when: always
